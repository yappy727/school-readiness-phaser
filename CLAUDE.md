# 小学校入学準備知育アプリ開発仕様書（Phaser版）

## プロジェクト概要

**プロジェクト名**: 小学校入学準備知育アプリ  
**対象年齢**: 4-6歳（発達障害・グレーゾーン対応）  
**プラットフォーム**: ブラウザ（Phaser.js + React + TypeScript）  
**主要機能**: 文字学習、数の概念学習、時計読み学習、レベル選択システム

---

## 技術仕様

### **開発環境**
- **ゲームエンジン**: Phaser 3.90.0
- **フロントエンド**: React 19.1.0 + TypeScript
- **ビルドツール**: Vite
- **音声**: Web Audio API (AudioManager)
- **状態管理**: React Hooks
- **スタイリング**: CSS-in-JS

### **プラットフォーム対応**
- **Web**: 全ブラウザ対応（Chrome、Firefox、Safari、Edge）
- **モバイル**: タッチ操作対応（iOS Safari、Android Chrome）
- **PC**: マウス・キーボード操作対応

### **パフォーマンス**
- **解像度**: 800x600基準、レスポンシブ対応
- **フレームレート**: 60fps維持
- **ロード時間**: 初回3秒以内

---

## プロジェクト構造

```
src/
├── game/                    # Phaser ゲーム関連
│   ├── PhaserGame.ts       # ゲームマネージャー
│   ├── AudioManager.ts     # 音響システム
│   └── scenes/             # ゲームシーン
│       ├── MenuScene.ts    # メインメニュー
│       ├── HiraganaScene.ts # ひらがな学習
│       ├── KatakanaScene.ts # カタカナ学習
│       ├── NumberScene.ts   # 数字学習
│       └── ClockScene.ts    # 時計学習
├── components/             # React コンポーネント
├── App.tsx                # メインアプリ
└── main.tsx              # エントリーポイント
```

---

## 実装済み機能

### **1. ゲームメニューシステム**
- **メインメニュー**: 4つの学習ゲームから選択
  - ひらがな学習
  - カタカナ学習  
  - すうじ学習
  - とけい学習
- **キャラクター**: まなちゃん（学習サポートキャラクター）
- **UI**: カラフルなグラデーション背景、アニメーション効果

### **2. ひらがな学習ゲーム**
- **行選択システム**: あ行〜わ行、すべての行から選択可能
- **文字認識問題**: ひらがな文字の選択式クイズ（1行あたり10問）
- **単語データベース**: 42単語（子供に親しみやすい言葉）
- **ヒントシステム**: 
  - ヒントボタンで手動表示
  - 間違い時に自動表示（10秒間）
  - 音声読み上げ機能（Web Speech API）
  - クリックで即座に非表示
- **イラスト**: プログラマティック描画による高精度イラスト
- **進捗管理**: 残り問題数表示、完了でクリア画面表示

### **3. カタカナ学習ゲーム**
- **行選択システム**: ア行〜ワ行、すべての行から選択可能
- **文字認識問題**: カタカナ文字の選択式クイズ（1行あたり10問）
- **単語データベース**: 42単語（外来語・カタカナ語）
- **ヒントシステム**: ひらがなゲームと同仕様
- **イラスト**: 詳細なプログラマティック描画（30要素以上）
- **進捗管理**: 残り問題数表示、完了でクリア画面表示

### **4. すうじ学習ゲーム（4レベル対応）**

#### **レベル選択システム**
- **レベル1**: 1-3の数字（完全ランダム）
- **レベル2**: 1-5の数字（重複回避）
- **レベル3**: 1-10の数字（重複回避）
- **レベル4**: 1-20の数字（重複回避）

#### **数え上げゲーム**
- **オブジェクト**: りんごを数える
- **配置ルール**:
  - レベル1,2（5個以下）: 中央に1行配置
  - レベル3,4（6個以上）: 5個単位でグループ化
    - 1行目: 最大2グループ（左右配置）
    - 2行目: 11個以上で追加グループ配置
- **インタラクション**: りんごをタップして数え上げ
- **回答方式**: 数字ボタンで回答選択
- **クリア条件**: 5問正解でレベルクリア
- **残り問題数**: 画面右上に表示

### **5. とけい学習ゲーム（4レベル対応）**

#### **レベル選択システム**
- **レベル1**: ちょうど○時（1-12時）
- **レベル2**: ○時半（1-12時半）
- **レベル3**: 5分間隔（○じ○○ふん）
- **レベル4**: 1分間隔（○じ○○ふん）

#### **時計表示**
- **アナログ時計**: 文字盤、短針・長針表示
- **時刻生成**: レベルに応じた時刻の自動生成（重複回避）
- **選択肢**: レベル3,4では同じ時間で分だけ異なる選択肢
- **クリア条件**: 5問正解でレベルクリア
- **残り問題数**: 画面右上に表示（スコアは非表示）

### **6. 音響システム（AudioManager）**

#### **BGM**
- **Web Audio API**: プログラマティック音楽生成
- **スタイル**: ポップでゲームらしいテトリス風メロディー
- **音量**: 0.05（背景音楽として控えめ）
- **ループ再生**: 自動ループ機能

#### **効果音**
- **ボタン音**: 音量 0.8
- **正解音**: 明るい3音階メロディー（音量 1.0）
- **不正解音**: 低音ブザー（音量 1.0）
- **自動再生**: ユーザーインタラクション後に開始

### **7. UI/UXデザイン**

#### **カラーパレット**
- **ピンク系**: #ff69b4（ひらがな）
- **紫系**: #8b5cf6（カタカナ）
- **赤系**: #dc2626（すうじ）
- **オレンジ系**: #e17055（とけい）

#### **アニメーション**
- **入場エフェクト**: ボタンのフェードイン、スケール
- **ホバーエフェクト**: 1.1倍拡大
- **正解エフェクト**: パーティクルアニメーション
- **不正解エフェクト**: 振動アニメーション

#### **レスポンシブ対応**
- **基準解像度**: 800x600
- **スケーリング**: Phaser.Scale.FIT
- **センタリング**: Phaser.Scale.CENTER_BOTH

---

## ゲーム仕様詳細

### **スコアリングシステム**
- **正解**: 残り問題数カウントダウン
- **不正解**: ポイント変化なし
- **連続正解**: 追加ボーナスなし（シンプル設計）

### **難易度設定**
- **レベル自動調整**: なし（ユーザー選択制）
- **問題生成**: ランダム生成（重複回避機能付き）
- **復習機能**: なし（各問題独立）

### **ユーザビリティ**
- **戻るボタン**: 全画面に配置
- **音量調整**: デバイス本体音量に委ねる
- **進捗保存**: なし（セッション単位）
- **ボタン間隔**: 適切な間隔を保持（重複防止）

---

## データ構造

### **ゲーム状態管理**
```typescript
// HiraganaScene/KatakanaScene の状態例
private remainingWords: any[] = []; // 未出題の単語リスト
private completedWords: any[] = []; // 正解済みの単語リスト
private totalWords: number = 0; // 全単語数
private selectedLevel: string = 'all'; // 選択されたレベル（行）
private showingLevelSelect: boolean = true; // レベル選択画面表示中
private isProcessingAnswer: boolean = false; // 回答処理中
private isShowingHint: boolean = false; // ヒント表示中

// NumberScene の状態例
private currentLevel: number = 1;
private correctCount: number = 0; // 正解回数
private readonly maxCorrectCount: number = 5; // クリア条件
private usedNumbers: number[] = []; // 出題済みの数字

// ClockScene の状態例
private currentTime: { hour: number, minute: number } = { hour: 3, minute: 0 };
private correctCount: number = 0; // 正解回数
private readonly maxCorrectCount: number = 5; // クリア条件
private usedTimes: string[] = []; // 出題済みの時刻
```

### **音響設定**
```typescript
// AudioManager の音量設定
private volume = 0.7; // 基準音量
// BGM: volume * 0.05
// ボタン音: volume * 0.8  
// 正解音: volume * 1.0
// 不正解音: volume * 1.0
```

---

## 主要なバグ修正

### **実装済みの修正**
1. **ボタン重複問題**: クリア画面のボタン間隔を調整（50px→200px）
2. **状態管理の改善**: `isProcessingAnswer`フラグで連続タップ防止
3. **レベルボタン残留問題**: 明示的な破棄処理を追加
4. **ヒントシステム**: 即座にリフレッシュ可能に改善
5. **表示残留問題**: 画面遷移時の完全クリア処理
6. **重複出題回避**: 数字・時計ゲームで同じ問題を繰り返さない仕組み

---

## アクセシビリティ対応

### **発達障害・グレーゾーン対応**
- **シンプルUI**: 余計な情報を排除
- **大きなボタン**: タップしやすいサイズ
- **明確なフィードバック**: 音と視覚の両方
- **レベル選択**: 個人のペースに合わせた学習
- **ヒント機能**: 間違えても学習をサポート

### **視覚的配慮**
- **高コントラスト**: 背景と文字の明確な区別
- **アニメーション**: 過度でない、優しい動き
- **カラーコード**: 各学習分野で色分け
- **詳細なイラスト**: 視覚的理解をサポート

### **聴覚的配慮**
- **音量バランス**: BGMは控えめ、効果音は明確
- **効果音**: 短時間で分かりやすい
- **音声読み上げ**: ヒント機能で対応
- **音声なし**: 文字のみでも理解可能

---

## 技術的実装詳細

### **Phaserシーン管理**
```typescript
// シーン登録
scene: [MenuScene, HiraganaScene, KatakanaScene, NumberScene, ClockScene]

// シーン切り替え
this.scene.start('MenuScene');

// レベルボタンの破棄処理
this.levelButtons.forEach(button => button.destroy());
this.levelButtons = [];
```

### **Web Audio API活用**
```typescript
// BGM生成例
private playEducationalBGM(): void {
  const melody = [
    { note: 659, duration: 0.4 }, // E
    { note: 587, duration: 0.2 }, // D
    // ...
  ];
  this.playMelodyLoop(melody);
}
```

### **音声合成API**
```typescript
// ヒント読み上げ
private speakHint(text: string): void {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    utterance.rate = 0.7;
    utterance.pitch = 1.2;
    speechSynthesis.speak(utterance);
  }
}
```

### **レスポンシブ配置**
```typescript
// 画面中央配置
const x = this.cameras.main.centerX;
const y = this.cameras.main.centerY;

// 相対配置
const buttonX = (this.cameras.main.width / 5) * (index + 1);
```

---

## パフォーマンス最適化

### **描画最適化**
- **Graphics オブジェクト**: 単純図形で軽量化
- **テクスチャなし**: プログラマティック描画
- **オブジェクトプール**: パーティクルの再利用

### **メモリ管理**
- **オブジェクト破棄**: destroy() での適切な削除
- **イベントリスナー**: 不要時の削除
- **タイマー**: delayedCall の適切な管理

### **音響最適化**
- **オシレーター**: 使い捨てで軽量
- **ゲインノード**: 適切な接続・切断
- **コンテキスト管理**: 単一AudioContext使用

---

## ブラウザ対応

### **対応ブラウザ**
- **デスクトップ**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **モバイル**: iOS Safari 14+, Android Chrome 90+

### **必要機能**
- **Web Audio API**: 音響機能に必須
- **Canvas**: Phaser描画に必須
- **ES2020**: TypeScriptコンパイル済み
- **Speech Synthesis API**: ヒント読み上げ機能

### **フォールバック**
- **音響エラー**: コンソールログのみ、ゲーム継続
- **タッチ未対応**: マウスイベントで代替
- **レガシーブラウザ**: 基本動作のみ保証
- **音声合成未対応**: テキスト表示で対応

---

## 今後の拡張予定

### **学習コンテンツ**
- [ ] 書字練習（ひらがな・カタカナ）
- [ ] 簡単な足し算・引き算
- [ ] 生活時間の学習（朝・昼・夜）
- [ ] 簡易イラストの改善（15要素以下のイラストを詳細化）

### **システム機能**
- [ ] 学習履歴保存（localStorage）
- [ ] 保護者向けレポート機能
- [ ] 複数ユーザー対応
- [ ] オフライン対応（PWA化）

### **アクセシビリティ**
- [ ] 音声読み上げ機能の拡充
- [ ] キーボードナビゲーション
- [ ] 色覚異常対応
- [ ] 字幕機能

---

このPhaserアプリは、発達障害・グレーゾーンのお子さんも含めて、すべての子どもが楽しく小学校入学準備を進められることを目標とし、ブラウザ上で手軽に利用できるよう設計されています。

## 更新履歴

### 2024年最新版
- ひらがな・カタカナゲームにヒントシステムを実装
- 数字・時計ゲームに5問クリア制を導入
- 重複出題回避機能を追加
- UI/UXの大幅改善（ボタン配置、状態管理）
- 多数のバグ修正と安定性向上